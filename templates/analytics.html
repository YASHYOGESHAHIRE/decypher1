<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compliance Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .sidebar { position: fixed; top: 0; left: 0; height: 100vh; overflow-y: auto; width: 20rem; background-color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        .main-content { margin-left: 20rem; padding: 2rem; }
        .chart-card { background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.25rem; font-weight: 500; transition: background-color 0.2s; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        @media (max-width: 1024px) {
            .sidebar { position: relative; width: 100%; height: auto; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <!-- Navigation removed for iframe embedding -->
    
    <div class="flex">
        <!-- Sidebar for Filters -->
        <div class="sidebar">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Filters</h2>
            <div class="space-y-4">
                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Search</label>
                    <input type="text" id="search" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Search products...">
                </div>

                <!-- Categories -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Categories</label>
                    <select multiple id="categories" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Food">Food</option>
                        <option value="Beauty">Beauty</option>
                        <option value="Unknown">Unknown</option>
                    </select>
                </div>

                <!-- Brands -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Brands</label>
                    <select multiple id="brands" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="Unknown">Unknown</option>
                    </select>
                </div>

                <!-- Platforms -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Platforms</label>
                    <select multiple id="platforms" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="Amazon">Amazon</option>
                    </select>
                </div>

                <!-- Compliance Status -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Compliance Status</label>
                    <select multiple id="statuses" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="Full">Full</option>
                        <option value="Partial">Partial</option>
                        <option value="Non-compliant">Non-compliant</option>
                    </select>
                </div>

                <!-- Field Presence -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Field Presence</label>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="mrp_status" value="mrp_status:present" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label class="ml-2 text-sm text-gray-700" for="mrp_status">MRP</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="net_quantity_status" value="net_quantity_status:present" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label class="ml-2 text-sm text-gray-700" for="net_quantity_status">Net Quantity</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="expiry_date_status" value="expiry_date_status:present" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label class="ml-2 text-sm text-gray-700" for="expiry_date_status">Expiry Date</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="manufacturer_status" value="manufacturer_status:present" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label class="ml-2 text-sm text-gray-700" for="manufacturer_status">Manufacturer</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="country_of_origin_status" value="country_of_origin_status:present" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label class="ml-2 text-sm text-gray-700" for="country_of_origin_status">Country of Origin</label>
                        </div>
                    </div>
                </div>

                <!-- Compliance Percentage Range -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Compliance %</label>
                    <div class="flex space-x-2">
                        <input type="number" id="compliance_min" class="w-1/2 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Min">
                        <input type="number" id="compliance_max" class="w-1/2 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Max">
                    </div>
                </div>

                <!-- OCR Confidence -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">OCR Confidence</label>
                    <input type="number" id="ocr_min" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Min">
                </div>

                <!-- Violations Count -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Violations Count</label>
                    <div class="flex space-x-2">
                        <input type="number" id="violations_min" class="w-1/2 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Min">
                        <input type="number" id="violations_max" class="w-1/2 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Max">
                    </div>
                </div>

                <!-- Crawl Date Range -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Crawl Date</label>
                    <div class="flex space-x-2">
                        <input type="date" id="date_start" class="w-1/2 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <input type="date" id="date_end" class="w-1/2 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Geo Location -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Geo Location</label>
                    <select multiple id="geos" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="Pune, Maharashtra">Pune, Maharashtra</option>
                    </select>
                </div>

                <!-- Sort -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Sort By</label>
                    <select id="sort" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="compliance_percent:desc">Compliance % (Desc)</option>
                        <option value="compliance_percent:asc">Compliance % (Asc)</option>
                        <option value="crawl_date:desc">Crawl Date (Desc)</option>
                        <option value="crawl_date:asc">Crawl Date (Asc)</option>
                        <option value="violations_count:desc">Violations Count (Desc)</option>
                        <option value="violations_count:asc">Violations Count (Asc)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-3">Legal Metrology Compliance Analytics</h1>
                <p class="text-lg text-gray-600 mb-6">Comprehensive monitoring and analysis of e-commerce platform compliance with Legal Metrology (Packaged Commodities) Rules, 2011. Track violations, monitor trends, and generate regulatory reports.</p>
                <div class="flex justify-between items-center">
                    <div class="flex space-x-4">
                        <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                            📊 Real-time Monitoring
                        </div>
                        <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            🎯 Violation Detection
                        </div>
                        <div class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                            📈 Trend Analysis
                        </div>
                    </div>
                    <div class="space-x-2">
                        <button id="refresh-btn" class="btn btn-primary">🔄 Refresh Data</button>
                        <button id="export-btn" class="btn btn-secondary">📥 Export Report</button>
                    </div>
                </div>
            </div>

            <div id="loading" class="text-center text-gray-600 mb-4 hidden">Loading data...</div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Compliance Status Pie Chart -->
                <div class="chart-card">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Compliance Status Distribution</h3>
                    <canvas id="status-pie-chart"></canvas>
                </div>

                <!-- Violations Count Bar Chart -->
                <div class="chart-card">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Violations by Category</h3>
                    <canvas id="violations-bar-chart"></canvas>
                </div>

                <!-- Compliance Trend Line Chart -->
                <div class="chart-card">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Compliance Trend Over Time</h3>
                    <canvas id="compliance-line-chart"></canvas>
                </div>

                <!-- OCR Confidence Histogram -->
                <div class="chart-card">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">OCR Confidence Distribution</h3>
                    <canvas id="ocr-histogram"></canvas>
                </div>

                <!-- Field Presence Doughnut Chart -->
                <div class="chart-card">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Field Presence Overview</h3>
                    <canvas id="field-doughnut-chart"></canvas>
                </div>

                <!-- Geo Location Bar Chart -->
                <div class="chart-card">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Compliance by Geo Location</h3>
                    <canvas id="geo-bar-chart"></canvas>
                </div>
            </div>

            <!-- Paginated Table -->
            <div class="chart-card overflow-x-auto">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">Detailed Compliance Data</h3>
                <table id="data-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Brand</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Platform</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Compliance %</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Violations</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">OCR Confidence</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Crawl Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Geo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fields</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Link</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="mt-4 flex justify-between items-center">
                <div id="pagination-info" class="text-sm text-gray-600"></div>
                <div class="flex space-x-2">
                    <button id="prev-page" class="btn btn-secondary disabled:opacity-50" disabled>Previous</button>
                    <button id="next-page" class="btn btn-secondary disabled:opacity-50" disabled>Next</button>
                </div>
                <select id="page-size" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <option value="10">10 per page</option>
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        let page = 1;
        let limit = 10;
        let total = 0;
        let allData = []; // To store full filtered data for charts

        function getFilters() {
            const fields = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(input => input.value);
            const categories = Array.from(document.getElementById('categories').selectedOptions).map(option => option.value);
            const brands = Array.from(document.getElementById('brands').selectedOptions).map(option => option.value);
            const platforms = Array.from(document.getElementById('platforms').selectedOptions).map(option => option.value);
            const statuses = Array.from(document.getElementById('statuses').selectedOptions).map(option => option.value);
            const geos = Array.from(document.getElementById('geos').selectedOptions).map(option => option.value);

            return {
                q: document.getElementById('search').value,
                categories,
                brands,
                platforms,
                statuses,
                fields,
                compliance_min: document.getElementById('compliance_min').value,
                compliance_max: document.getElementById('compliance_max').value,
                ocr_min: document.getElementById('ocr_min').value,
                violations_min: document.getElementById('violations_min').value,
                violations_max: document.getElementById('violations_max').value,
                date_start: document.getElementById('date_start').value,
                date_end: document.getElementById('date_end').value,
                geos,
                sort: document.getElementById('sort').value
            };
        }

        async function fetchData(fullFetch = false) {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const filters = getFilters();
                const params = new URLSearchParams();
                if (filters.q) params.append('q', filters.q);
                filters.categories.forEach(cat => params.append('categories', cat));
                filters.brands.forEach(brand => params.append('brands', brand));
                filters.platforms.forEach(platform => params.append('platforms', platform));
                filters.statuses.forEach(status => params.append('statuses', status));
                filters.fields.forEach(field => params.append('fields', field));
                if (filters.compliance_min) params.append('compliance_min', filters.compliance_min);
                if (filters.compliance_max) params.append('compliance_max', filters.compliance_max);
                if (filters.ocr_min) params.append('ocr_min', filters.ocr_min);
                if (filters.violations_min) params.append('violations_min', filters.violations_min);
                if (filters.violations_max) params.append('violations_max', filters.violations_max);
                if (filters.date_start) params.append('date_start', filters.date_start);
                if (filters.date_end) params.append('date_end', filters.date_end);
                filters.geos.forEach(geo => params.append('geos', geo));
                params.append('sort', filters.sort);
                if (!fullFetch) {
                    params.append('page', page);
                    params.append('limit', limit);
                } else {
                    params.append('page', 1);
                    params.append('limit', 1000); // Fetch a large number for charts
                }

                const response = await fetch(`http://localhost:8000/api/data?${params.toString()}`);
                const result = await response.json();
                if (fullFetch) {
                    allData = result.data || [];
                } else {
                    total = result.total || 0;
                    renderTable(result.data || []);
                    updatePagination();
                }
                return result.data || [];
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('table-body').innerHTML = '<tr><td colspan="12" class="px-6 py-4 text-center text-red-600">Error loading data</td></tr>';
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900">${item.name || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.category || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.brand || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.platform || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.compliance_percent}%</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.compliance_status}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.violations_count}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${parseFloat(item.ocr_confidence_avg).toFixed(2)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${new Date(item.crawl_date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.geo_location}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${JSON.parse(item.actual_list || '[]').join(', ') || 'None'}</td>
                    <td class="px-6 py-4 text-sm"><a href="${item.product_link}" target="_blank" class="text-blue-600 hover:underline">View</a></td>
                `;
                tbody.appendChild(row);
            });
            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="12" class="px-6 py-4 text-center text-gray-500">No data available</td></tr>';
            }
        }

        function updatePagination() {
            const totalPages = Math.ceil(total / limit);
            document.getElementById('pagination-info').textContent = `Showing ${(page - 1) * limit + 1} to ${Math.min(page * limit, total)} of ${total} entries`;
            document.getElementById('prev-page').disabled = page === 1;
            document.getElementById('next-page').disabled = page === totalPages;
        }

        async function renderCharts() {
            const data = allData.length ? allData : await fetchData(true);

            // Compliance Status Pie Chart
            const statusCounts = data.reduce((acc, item) => {
                acc[item.compliance_status] = (acc[item.compliance_status] || 0) + 1;
                return acc;
            }, {});
            new Chart(document.getElementById('status-pie-chart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#22c55e', '#eab308', '#ef4444']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });

            // Violations by Category Bar Chart
            const violationsByCategory = data.reduce((acc, item) => {
                if (!acc[item.category]) acc[item.category] = { count: 0, total: 0 };
                acc[item.category].count += item.violations_count;
                acc[item.category].total += 1;
                return acc;
            }, {});
            new Chart(document.getElementById('violations-bar-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(violationsByCategory),
                    datasets: [{
                        label: 'Average Violations',
                        data: Object.values(violationsByCategory).map(v => v.count / v.total),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });

            // Compliance Trend Line Chart
            const complianceTrend = data.reduce((acc, item) => {
                const date = new Date(item.crawl_date).toLocaleDateString();
                if (!acc[date]) acc[date] = { sum: 0, count: 0 };
                acc[date].sum += item.compliance_percent;
                acc[date].count += 1;
                return acc;
            }, {});
            const sortedDates = Object.keys(complianceTrend).sort((a, b) => new Date(a) - new Date(b));
            new Chart(document.getElementById('compliance-line-chart'), {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Average Compliance %',
                        data: sortedDates.map(date => complianceTrend[date].sum / complianceTrend[date].count),
                        borderColor: '#10b981',
                        fill: false
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
            });

            // OCR Confidence Histogram
            const ocrBins = Array(10).fill(0);
            data.forEach(item => {
                const bin = Math.min(Math.floor(item.ocr_confidence_avg * 10), 9);
                ocrBins[bin]++;
            });
            new Chart(document.getElementById('ocr-histogram'), {
                type: 'bar',
                data: {
                    labels: ['0-0.1', '0.1-0.2', '0.2-0.3', '0.3-0.4', '0.4-0.5', '0.5-0.6', '0.6-0.7', '0.7-0.8', '0.8-0.9', '0.9-1.0'],
                    datasets: [{
                        label: 'Count',
                        data: ocrBins,
                        backgroundColor: '#6366f1'
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });

            // Field Presence Doughnut Chart
            const fieldCounts = {
                MRP: 0, 'Net Quantity': 0, 'Expiry Date': 0, Manufacturer: 0, 'Country of Origin': 0
            };
            data.forEach(item => {
                if (item.mrp_status === 'present') fieldCounts.MRP++;
                if (item.net_quantity_status === 'present') fieldCounts['Net Quantity']++;
                if (item.expiry_date_status === 'present') fieldCounts['Expiry Date']++;
                if (item.manufacturer_status === 'present') fieldCounts.Manufacturer++;
                if (item.country_of_origin_status === 'present') fieldCounts['Country of Origin']++;
            });
            new Chart(document.getElementById('field-doughnut-chart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(fieldCounts),
                    datasets: [{
                        data: Object.values(fieldCounts),
                        backgroundColor: ['#ef4444', '#eab308', '#22c55e', '#3b82f6', '#6366f1']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'right' } } }
            });

            // Compliance by Geo Bar Chart
            const geoCompliance = data.reduce((acc, item) => {
                if (!acc[item.geo_location]) acc[item.geo_location] = { sum: 0, count: 0 };
                acc[item.geo_location].sum += item.compliance_percent;
                acc[item.geo_location].count += 1;
                return acc;
            }, {});
            new Chart(document.getElementById('geo-bar-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(geoCompliance),
                    datasets: [{
                        label: 'Average Compliance %',
                        data: Object.values(geoCompliance).map(v => v.sum / v.total),
                        backgroundColor: '#14b8a6'
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        // Event Listeners
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('change', debounce(() => {
                page = 1;
                allData = []; // Reset chart data
                fetchData();
                renderCharts();
            }, 300));
        });

        document.getElementById('prev-page').addEventListener('click', () => {
            if (page > 1) {
                page--;
                fetchData();
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            if (page < Math.ceil(total / limit)) {
                page++;
                fetchData();
            }
        });

        document.getElementById('page-size').addEventListener('change', (e) => {
            limit = parseInt(e.target.value);
            page = 1;
            fetchData();
        });

        document.getElementById('refresh-btn').addEventListener('click', () => {
            page = 1;
            allData = [];
            fetchData();
            renderCharts();
        });

        document.getElementById('export-btn').addEventListener('click', () => {
            const csvContent = "data:text/csv;charset=utf-8," + [
                ["Product Name", "Category", "Brand", "Platform", "Compliance %", "Status", "Violations", "OCR Confidence", "Crawl Date", "Geo", "Fields", "Link"],
                ...allData.map(item => [
                    item.name || 'N/A',
                    item.category || 'N/A',
                    item.brand || 'N/A',
                    item.platform || 'N/A',
                    item.compliance_percent,
                    item.compliance_status,
                    item.violations_count,
                    item.ocr_confidence_avg.toFixed(2),
                    new Date(item.crawl_date).toLocaleDateString(),
                    item.geo_location,
                    JSON.parse(item.actual_list || '[]').join(', ') || 'None',
                    item.product_link
                ])
            ].map(row => row.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "compliance_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Initial Load
        fetchData();
        renderCharts();
    </script>
</body>
</html>